<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crawler Doanh Nghi·ªáp - Multi Site</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 900px;
            width: 100%;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            width: auto;
            cursor: pointer;
        }

        .radio-option label {
            margin: 0;
            cursor: pointer;
            font-weight: 400;
        }

        .site-url {
            font-size: 0.9em;
            color: #888;
            font-style: italic;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin-top: 30px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
            display: none;
        }

        .status.show {
            display: block;
        }

        .status h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .status-message {
            color: #666;
            line-height: 1.6;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            margin-top: 20px;
        }

        .company-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .company-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .company-card p {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }

        .success {
            color: #4caf50;
            font-weight: 600;
        }

        .error {
            color: #f44336;
            font-weight: 600;
        }

        .download-btn {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            margin-top: 20px;
        }

        .download-btn:hover {
            box-shadow: 0 10px 20px rgba(76, 175, 80, 0.4);
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 25px;
            border-radius: 4px;
        }

        .info-box p {
            color: #1976d2;
            line-height: 1.6;
        }

        .url-input-group {
            display: flex;
            gap: 10px;
            align-items: end;
        }

        .url-input-group > div {
            flex: 1;
        }

        .check-btn {
            width: auto;
            padding: 12px 30px;
            margin-top: 0;
            white-space: nowrap;
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }

        .check-btn:hover {
            box-shadow: 0 10px 20px rgba(255, 152, 0, 0.4);
        }

        .page-info {
            margin-top: 10px;
            padding: 10px 15px;
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            border-radius: 4px;
            color: #2e7d32;
            font-weight: 600;
            display: none;
        }

        .page-info.show {
            display: block;
        }

        .page-info.error {
            background: #ffebee;
            border-left-color: #f44336;
            color: #c62828;
        }

        .progress-box {
            margin-top: 20px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
            display: none;
        }

        .progress-box.show {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .progress-text {
            color: #666;
            text-align: center;
            margin: 10px 0;
            font-size: 14px;
        }

        .current-company {
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 13px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üï∑Ô∏è Crawler Doanh Nghi·ªáp</h1>
        <p class="subtitle">Multi-Site Crawler - T·ª± ƒë·ªông crawl v√† xu·∫•t Excel</p>

        <div class="info-box">
            <p><strong>H∆∞·ªõng d·∫´n:</strong> Ch·ªçn trang web, nh·∫≠p s·ªë trang b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c ƒë·ªÉ crawl d·ªØ li·ªáu doanh nghi·ªáp. 
            H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông click v√†o t·ª´ng link ƒë·ªÉ l·∫•y th√¥ng tin chi ti·∫øt v√† xu·∫•t ra file Excel.</p>
        </div>

        <form id="crawlForm">
            <input type="hidden" id="detectedWebsite" name="website" value="">
            
            <div class="form-group">
                <label>URL trang web:</label>
                <div class="url-input-group">
                    <div>
                        <input type="url" id="websiteUrl" placeholder="Nh·∫≠p link trang web c·∫ßn crawl" required>
                    </div>
                    <button type="button" class="check-btn" id="checkPagesBtn">üîç Ki·ªÉm tra</button>
                </div>
                <div class="page-info" id="pageInfo"></div>
            </div>

            <div class="row">
                <div class="form-group">
                    <label>Trang b·∫Øt ƒë·∫ßu:</label>
                    <input type="number" id="startPage" value="1" min="1" required>
                </div>
                <div class="form-group">
                    <label>Trang k·∫øt th√∫c:</label>
                    <input type="number" id="endPage" value="3" min="1" required>
                </div>
            </div>
            
            <div style="text-align: center; margin: 10px 0; font-weight: bold; font-size: 14px;" id="usageInfo"></div>
            <div style="text-align: center; margin: 5px 0; font-size: 12px; transition: all 0.3s;" id="pageRangeWarning">
                <span style="color: #666;">‚ö†Ô∏è Gi·ªõi h·∫°n: T·ªëi ƒëa 3 trang m·ªói l·∫ßn c√†o</span>
            </div>

            <button type="submit" id="startBtn">B·∫Øt ƒë·∫ßu C√†o</button>
        </form>

        <div class="status" id="status">
            <h3>Tr·∫°ng th√°i</h3>
            <div class="status-message" id="statusMessage"></div>
            
            <div class="progress-box" id="progressBox">
                <div class="progress-text" id="progressText">ƒêang kh·ªüi t·∫°o...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
                </div>
                <div class="current-company" id="currentCompany"></div>
            </div>
            <button class="download-btn" id="downloadBtn" style="display: none;">
                üì• T·∫£i xu·ªëng Excel
            </button>
            
            <div class="results" id="results"></div>
        </div>
    </div>

    <script>
        let crawledData = [];
        
        // Usage limit settings
        const MAX_ATTEMPTS = 19;
        const MAX_PAGE_RANGE = 3;
        const STORAGE_KEY = 'crawler_usage';
        
        // Get usage count from localStorage
        function getUsageCount() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (!data) return 0;
            try {
                const parsed = JSON.parse(data);
                return parsed.count || 0;
            } catch {
                return 0;
            }
        }
        
        // Increment usage count
        function incrementUsage() {
            const count = getUsageCount() + 1;
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ count, lastUsed: new Date().toISOString() }));
            updateUsageDisplay();
            return count;
        }
        
        // Check if user has attempts left
        function hasAttemptsLeft() {
            return getUsageCount() < MAX_ATTEMPTS;
        }
        
        // Get remaining attempts
        function getRemainingAttempts() {
            return Math.max(0, MAX_ATTEMPTS - getUsageCount());
        }
        
        // Update usage display
        function updateUsageDisplay() {
            const remaining = getRemainingAttempts();
            const usageInfo = document.getElementById('usageInfo');
            if (usageInfo) {
                if (remaining > 0) {
                    usageInfo.textContent = `C√≤n l·∫°i: ${remaining}/${MAX_ATTEMPTS} l·∫ßn l·∫•y data`;
                    usageInfo.style.color = remaining <= 3 ? '#ff6b6b' : '#4CAF50';
                } else {
                    usageInfo.textContent = `‚ùå ƒê√£ h·∫øt l∆∞·ª£t s·ª≠ d·ª•ng (${MAX_ATTEMPTS}/${MAX_ATTEMPTS})`;
                    usageInfo.style.color = '#ff6b6b';
                }
            }
        }
        
        // Initialize usage display on page load
        window.addEventListener('DOMContentLoaded', updateUsageDisplay);
        
        // Validate page range realtime
        function validatePageRange() {
            const startPage = parseInt(document.getElementById('startPage').value) || 0;
            const endPage = parseInt(document.getElementById('endPage').value) || 0;
            const warningDiv = document.getElementById('pageRangeWarning');
            
            if (!warningDiv) return;
            
            const pageRange = endPage - startPage + 1;
            
            if (startPage > 0 && endPage > 0 && startPage <= endPage) {
                if (pageRange <= MAX_PAGE_RANGE) {
                    // Valid range - show success message
                    warningDiv.innerHTML = `<span style="color: #4CAF50;">‚úÖ H·ª£p l·ªá: ${pageRange} trang (t·ª´ ${startPage} ƒë·∫øn ${endPage})</span>`;
                } else {
                    // Invalid range - show error
                    warningDiv.innerHTML = `<span style="color: #ff6b6b;">‚ùå V∆∞·ª£t gi·ªõi h·∫°n: ${pageRange} trang (t·ªëi ƒëa ${MAX_PAGE_RANGE} trang)</span>`;
                }
            } else {
                // Default message
                warningDiv.innerHTML = `<span style="color: #666;">‚ö†Ô∏è Gi·ªõi h·∫°n: T·ªëi ƒëa ${MAX_PAGE_RANGE} trang m·ªói l·∫ßn crawl</span>`;
            }
        }
        
        // Add event listeners for page inputs
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('startPage').addEventListener('input', validatePageRange);
            document.getElementById('endPage').addEventListener('input', validatePageRange);
            validatePageRange(); // Initial check
        });

        // Check pages button handler
        document.getElementById('checkPagesBtn').addEventListener('click', async () => {
            const url = document.getElementById('websiteUrl').value;
            const pageInfo = document.getElementById('pageInfo');
            const checkBtn = document.getElementById('checkPagesBtn');
            
            if (!url) {
                pageInfo.textContent = '‚ö†Ô∏è Vui l√≤ng nh·∫≠p URL';
                pageInfo.className = 'page-info error show';
                return;
            }

            checkBtn.disabled = true;
            checkBtn.textContent = '‚è≥ ƒêang ki·ªÉm tra...';
            pageInfo.textContent = 'ƒêang ph√¢n t√≠ch trang web...';
            pageInfo.className = 'page-info show';

            try {
                const response = await fetch('/api/check-pages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                const result = await response.json();

                if (response.ok) {
                    pageInfo.textContent = `‚úÖ T√¨m th·∫•y ${result.totalPages} trang | Website: ${result.siteName}`;
                    pageInfo.className = 'page-info show';
                    
                    // Auto-fill end page and store detected website
                    document.getElementById('endPage').value = result.totalPages;
                    document.getElementById('detectedWebsite').value = result.website;
                } else {
                    pageInfo.textContent = `‚ùå ${result.error || 'Kh√¥ng th·ªÉ ki·ªÉm tra trang'}`;
                    pageInfo.className = 'page-info error show';
                }
            } catch (error) {
                pageInfo.textContent = '‚ùå L·ªói k·∫øt n·ªëi: ' + error.message;
                pageInfo.className = 'page-info error show';
            } finally {
                checkBtn.disabled = false;
                checkBtn.textContent = 'üîç Ki·ªÉm tra';
            }
        });

        document.getElementById('crawlForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const startPage = parseInt(document.getElementById('startPage').value);
            const endPage = parseInt(document.getElementById('endPage').value);
            const website = document.getElementById('detectedWebsite').value;
            
            if (!website) {
                alert('Vui l√≤ng ki·ªÉm tra URL tr∆∞·ªõc khi crawl!');
                return;
            }
            
            // Check usage limit
            if (!hasAttemptsLeft()) {
                alert(`‚ùå B·∫°n ƒë√£ h·∫øt l∆∞·ª£t s·ª≠ d·ª•ng!\n\nƒê√£ s·ª≠ d·ª•ng: ${MAX_ATTEMPTS}/${MAX_ATTEMPTS} l·∫ßn\n\nVui l√≤ng x√≥a d·ªØ li·ªáu tr√¨nh duy·ªát ƒë·ªÉ reset (ho·∫∑c li√™n h·ªá admin).`);
                return;
            }
            
            // Validate page range
            if (startPage > endPage) {
                alert('Trang b·∫Øt ƒë·∫ßu ph·∫£i nh·ªè h∆°n ho·∫∑c b·∫±ng trang k·∫øt th√∫c!');
                return;
            }
            
            // Check max page range (3 pages max)
            const pageRange = endPage - startPage + 1;
            if (pageRange > MAX_PAGE_RANGE) {
                alert(`‚ùå Gi·ªõi h·∫°n crawl: T·ªëi ƒëa ${MAX_PAGE_RANGE} trang m·ªói l·∫ßn!\n\nB·∫°n ƒëang ch·ªçn: ${pageRange} trang (t·ª´ ${startPage} ƒë·∫øn ${endPage})\n\nVui l√≤ng gi·∫£m kho·∫£ng c√°ch trang.`);
                return;
            }
            
            const startBtn = document.getElementById('startBtn');
            const status = document.getElementById('status');
            const statusMessage = document.getElementById('statusMessage');
            const results = document.getElementById('results');
            const downloadBtn = document.getElementById('downloadBtn');
            const progressBox = document.getElementById('progressBox');
            const progressText = document.getElementById('progressText');
            const progressFill = document.getElementById('progressFill');
            const currentCompany = document.getElementById('currentCompany');

            // Reset
            crawledData = [];
            status.classList.add('show');
            progressBox.classList.add('show');
            statusMessage.innerHTML = '<span class="loading"></span>ƒêang kh·ªüi ƒë·ªông crawler...';
            results.innerHTML = '';
            downloadBtn.style.display = 'none';
            startBtn.disabled = true;
            progressFill.style.width = '0%';
            progressFill.textContent = '0%';

            try {
                // Get checked URL for trangvang and hsct
                const checkedUrl = document.getElementById('websiteUrl').value.trim();
                
                // S·ª≠ d·ª•ng EventSource ƒë·ªÉ nh·∫≠n real-time progress
                let apiUrl = `/api/start-crawl?startPage=${startPage}&endPage=${endPage}&website=${website}`;
                
                // For trangvang and hsct, add the category URL
                if ((website === 'trangvang' || website === 'hsct') && checkedUrl) {
                    apiUrl += `&url=${encodeURIComponent(checkedUrl)}`;
                }
                
                const eventSource = new EventSource(apiUrl);
                
                eventSource.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'page') {
                        // C·∫≠p nh·∫≠t progress cho page
                        const progress = (data.currentPage / data.totalPages) * 100;
                        progressFill.style.width = progress + '%';
                        progressFill.textContent = Math.round(progress) + '%';
                        progressText.textContent = `üìÑ ${data.message}`;
                        currentCompany.textContent = '';
                        
                    } else if (data.type === 'company') {
                        // C·∫≠p nh·∫≠t progress cho company
                        const pageProgress = ((data.currentPage - 1) / data.totalPages) * 100;
                        const companyProgress = (data.currentCompany / data.totalCompanies) * (100 / data.totalPages);
                        const totalProgress = pageProgress + companyProgress;
                        
                        progressFill.style.width = totalProgress + '%';
                        progressFill.textContent = Math.round(totalProgress) + '%';
                        progressText.textContent = `üìÑ Trang ${data.currentPage}/${data.totalPages}`;
                        currentCompany.textContent = `üè¢ [${data.currentCompany}/${data.totalCompanies}] ${data.companyName}`;
                        
                    } else if (data.type === 'complete') {
                        // Ho√†n th√†nh
                        eventSource.close();
                        crawledData = data.data;
                        
                        // Increment usage count
                        const newCount = incrementUsage();
                        const remaining = getRemainingAttempts();
                        
                        progressFill.style.width = '100%';
                        progressFill.textContent = '100%';
                        progressText.textContent = `‚úÖ Ho√†n th√†nh! (C√≤n ${remaining} l·∫ßn)`;
                        currentCompany.textContent = '';
                        
                        statusMessage.innerHTML = `<span class="success">‚úì Crawl th√†nh c√¥ng!</span><br>
                            T·ªïng s·ªë: <strong>${data.count}</strong> doanh nghi·ªáp`;
                        
                        // Hi·ªÉn th·ªã preview
                        results.innerHTML = '<h4>K·∫øt qu·∫£:</h4>';
                        data.data.slice(0, 5).forEach((company, index) => {
                            results.innerHTML += `
                                <div class="company-card">
                                    <h4>${index + 1}. ${company.name}</h4>
                                    <p><strong>T√™n giao d·ªãch:</strong> ${company.tradingName || 'N/A'}</p>
                                    <p><strong>M√£ s·ªë thu·∫ø:</strong> ${company.taxCode || 'N/A'}</p>
                                    <p><strong>ƒê·∫°i di·ªán:</strong> ${company.legalRep || 'N/A'}</p>
                                    <p><strong>ƒê·ªãa ch·ªâ:</strong> ${company.address || 'N/A'}</p>
                                    <p><strong>ƒêi·ªán tho·∫°i:</strong> ${company.phone || 'N/A'}</p>
                                    <p><strong>Email:</strong> ${company.email || 'N/A'}</p>
                                    <p><strong>Tr·∫°ng th√°i:</strong> ${company.status || 'N/A'}</p>
                                </div>
                            `;
                        });

                        if (data.count > 5) {
                            results.innerHTML += `<p style="text-align: center; color: #666;">...v√† ${data.count - 5} c√¥ng ty kh√°c</p>`;
                        }

                        downloadBtn.style.display = 'block';
                        startBtn.disabled = false;
                        
                    } else if (data.type === 'error') {
                        // L·ªói
                        eventSource.close();
                        statusMessage.innerHTML = `<span class="error">‚úó L·ªói:</span> ${data.error}`;
                        progressBox.classList.remove('show');
                        startBtn.disabled = false;
                    }
                };

                eventSource.onerror = (error) => {
                    console.error('EventSource error:', error);
                    eventSource.close();
                    statusMessage.innerHTML = '<span class="error">‚úó L·ªói k·∫øt n·ªëi</span>';
                    progressBox.classList.remove('show');
                    startBtn.disabled = false;
                };

            } catch (error) {
                statusMessage.innerHTML = `<span class="error">‚úó L·ªói:</span> ${error.message}`;
                progressBox.classList.remove('show');
                startBtn.disabled = false;
            }
        });

        document.getElementById('downloadBtn').addEventListener('click', async () => {
            const downloadBtn = document.getElementById('downloadBtn');
            const originalText = downloadBtn.textContent;

            downloadBtn.disabled = true;
            downloadBtn.textContent = '‚è≥ ƒêang t·∫°o file...';

            try {
                const response = await fetch('/api/download-excel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ data: crawledData })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `doanh_nghiep_${Date.now()}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    downloadBtn.textContent = '‚úì ƒê√£ t·∫£i xu·ªëng!';
                    setTimeout(() => {
                        downloadBtn.textContent = originalText;
                        downloadBtn.disabled = false;
                    }, 2000);
                } else {
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i file');
                }
            } catch (error) {
                alert('L·ªói khi t·∫£i file: ' + error.message);
                downloadBtn.textContent = originalText;
                downloadBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
